<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đang tải... - News AI</title>
    <meta name="description" content="Đọc bài viết trên News AI - Tin tức thông minh, tổng hợp và dịch sang tiếng Việt.">
    <meta name="keywords" content="tin tức, news, AI, dịch tin tức, tổng hợp tin, tin thế giới, kinh tế, công nghệ, crypto">
    <meta property="og:title" content="News AI - Tin tức thông minh">
    <meta property="og:description" content="Đọc bài viết trên News AI - Tin tức thông minh, tổng hợp và dịch sang tiếng Việt.">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="News AI">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="News AI - Tin tức thông minh">
    <meta name="twitter:description" content="Đọc bài viết trên News AI - Tin tức thông minh, tổng hợp và dịch sang tiếng Việt.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/static/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }
                    }
                }
            }
        };
    </script>
</head>
<body class="bg-gray-50 font-sans antialiased" data-header-link-logo="true" data-header-show-stats="true">
    <div id="header-container"></div>
    <script src="/static/js/header.js"></script>
    <script src="/static/js/seo.js"></script>
    <script src="/static/js/filter.js"></script>
    <script>renderHeader({ linkLogo: true, showStats: true });</script>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Filters Sidebar (shared filter.js) -->
            <aside id="filterSidebarContainer" class="lg:w-64 flex-shrink-0">
                <!-- Rendered by filter.js -->
            </aside>

            <!-- Article content -->
            <article class="flex-1 min-w-0 max-w-4xl">
        <div id="articlePageContent">
            <div class="flex flex-col items-center justify-center py-20 text-gray-500">
                <svg class="w-12 h-12 animate-spin text-blue-500 mb-4" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>Đang tải bài viết...</p>
            </div>
        </div>

        <div id="relatedSection" class="mt-8 hidden">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                </svg>
                Bài viết cùng danh mục
            </h2>
            <div id="relatedArticlesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
        </div>
    </article>
        </div>
    </div>

    <script>
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        function getCategoryColor(category) {
            const colors = {
                'Tin thế giới': 'bg-blue-100 text-blue-700',
                'Kinh tế': 'bg-emerald-100 text-emerald-700',
                'Công nghệ': 'bg-purple-100 text-purple-700',
                'Crypto': 'bg-orange-100 text-orange-700',
                'Reuters World': 'bg-red-100 text-red-700',
            };
            return colors[category] || 'bg-gray-100 text-gray-700';
        }
        function markdownToHtml(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            html = html.replace(/^### (.+)$/gm, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2 class="text-xl font-bold text-gray-900 mt-5 mb-3">$1</h2>');
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold">$1</strong>');
            html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
            html = html.replace(/^[-•] (.+)$/gm, '<li class="ml-4">$1</li>');
            html = html.replace(/(<li[^>]*>.*<\/li>\n?)+/g, function(match) {
                return '<ul class="list-disc list-inside my-3 space-y-1">' + match + '</ul>';
            });
            html = html.replace(/\n\n/g, '</p><p class="mb-3">');
            html = '<p class="mb-3">' + html + '</p>';
            html = html.replace(/<p class="mb-3"><\/p>/g, '');
            html = html.replace(/<p class="mb-3">(\s*<h[23])/g, '$1');
            html = html.replace(/(<\/h[23]>)\s*<\/p>/g, '$1');
            html = html.replace(/<p class="mb-3">(\s*<ul)/g, '$1');
            html = html.replace(/(<\/ul>)\s*<\/p>/g, '$1');
            return html;
        }

        async function loadArticle() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (!id) {
                document.getElementById('articlePageContent').innerHTML = `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center">
                        <p class="text-gray-600">Thiếu id bài viết.</p>
                        <a href="/" class="mt-4 inline-block text-blue-600 hover:underline">Quay lại danh sách</a>
                    </div>`;
                return;
            }
            try {
                const res = await fetch('/api/articles/' + encodeURIComponent(id));
                const article = await res.json();
                if (article.error) {
                    document.getElementById('articlePageContent').innerHTML = `
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center">
                            <p class="text-gray-600">Không tìm thấy bài viết.</p>
                            <a href="/" class="mt-4 inline-block text-blue-600 hover:underline">Quay lại danh sách</a>
                        </div>`;
                    return;
                }
                renderArticle(article);
                var base = window.location.origin;
                var displayTitle = article.title_vn || article.title;
                var rawDesc = (article.summary_vn || article.summary || article.content || article.content_VN || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
                var desc = rawDesc.length > 160 ? rawDesc.slice(0, 157).replace(/\s+\S*$/, '') + '...' : rawDesc;
                setPageSEO({
                    title: (displayTitle || 'Bài viết') + ' | News AI',
                    description: desc || (displayTitle || 'Đọc bài viết trên News AI.'),
                    keywords: (article.category ? article.category + ', ' : '') + 'tin tức, news, AI, dịch tin tức, tổng hợp tin',
                    image: article.content_top_image || article.thumbnail || '',
                    canonical_url: base + '/article?id=' + encodeURIComponent(article.id),
                    og_type: 'article',
                    article_published_time: article.published ? new Date(article.published).toISOString() : undefined,
                    article_author: article.source || undefined,
                    article_section: article.category || undefined,
                    base_url: base
                });
                loadRelatedArticles(article.category, article.id);
            } catch (e) {
                document.getElementById('articlePageContent').innerHTML = `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center">
                        <p class="text-gray-600">Lỗi tải bài viết.</p>
                        <a href="/" class="mt-4 inline-block text-blue-600 hover:underline">Quay lại danh sách</a>
                    </div>`;
            }
        }

        function renderArticle(article) {
            const displayTitle = article.title_vn || article.title;
            document.title = escapeHtml(displayTitle) + ' - News AI';
            const publishedDate = article.published ? new Date(article.published).toLocaleDateString('vi-VN', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            }) : '';
            const heroImage = article.content_top_image || article.thumbnail || 'https://picsum.photos/seed/' + encodeURIComponent(displayTitle) + '/1200/600';
            const content = article.content_VN || article.content || (article.summary_vn || article.summary) || 'Không có nội dung chi tiết.';

            document.getElementById('articlePageContent').innerHTML = `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="relative">
                        <img src="${escapeHtml(heroImage)}" alt="${escapeHtml(displayTitle)}"
                            class="w-full h-72 sm:h-96 object-cover"
                            onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%221200%22 height=%22600%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22100%25%22 height=%22100%25%22/%3E%3Ctext fill=%22%239ca3af%22 font-family=%22sans-serif%22 font-size=%2224%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                        <div class="absolute bottom-4 left-4 right-4">
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="px-3 py-1 text-sm font-medium ${getCategoryColor(article.category)} rounded-full backdrop-blur-sm">${escapeHtml(article.category)}</span>
                                <span class="px-3 py-1 text-sm font-medium bg-white/90 text-gray-700 rounded-full backdrop-blur-sm">${escapeHtml(article.source || 'Unknown')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 sm:p-8 lg:p-10">
                        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-4 leading-tight">${escapeHtml(displayTitle)}</h1>
                        <div class="flex items-center text-sm text-gray-500 mb-8 pb-6 border-b border-gray-100">
                            <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            ${escapeHtml(publishedDate)}
                        </div>
                        <div class="prose prose-lg prose-gray max-w-none">
                            <div class="text-gray-700 leading-relaxed text-base sm:text-lg">${markdownToHtml(content)}</div>
                        </div>
                        <div class="mt-10 pt-8 border-t border-gray-100">
                            ${article.link ? '<p class="text-sm text-gray-500"><span class="font-medium text-gray-600">Nguồn:</span> <span class="break-all">' + escapeHtml(article.link) + '</span></p>' : ''}
                        </div>
                    </div>
                </div>`;
        }

        async function loadRelatedArticles(category, excludeId) {
            try {
                const params = new URLSearchParams({ page: 1, page_size: 5, category: category });
                const res = await fetch('/api/articles?' + params);
                const data = await res.json();
                const related = data.articles.filter(function(a) { return a.id !== excludeId; }).slice(0, 4);
                const grid = document.getElementById('relatedArticlesGrid');
                const section = document.getElementById('relatedSection');
                if (related.length === 0) {
                    section.classList.add('hidden');
                    return;
                }
                section.classList.remove('hidden');
                grid.innerHTML = related.map(function(article) {
                    const displayTitle = article.title_vn || article.title;
                    const thumbnail = article.thumbnail || 'https://picsum.photos/seed/' + encodeURIComponent(displayTitle) + '/400/240';
                    const url = '/article?id=' + encodeURIComponent(article.id);
                    return '<a href="' + escapeHtml(url) + '" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md hover:border-gray-200 transition-all block group">' +
                        '<div class="relative h-32 overflow-hidden">' +
                        '<img src="' + escapeHtml(thumbnail) + '" alt="" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"' +
                        ' onerror="this.onerror=null;this.src=\'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22240%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22100%25%22 height=%22100%25%22/%3E%3C/svg%3E\'">' +
                        '</div>' +
                        '<div class="p-3">' +
                        '<h3 class="text-sm font-medium text-gray-900 line-clamp-2 group-hover:text-blue-600 transition-colors">' + escapeHtml(displayTitle) + '</h3>' +
                        '<p class="text-xs text-gray-500 mt-1">' + escapeHtml(article.source || 'Unknown') + '</p>' +
                        '</div></a>';
                }).join('');
            } catch (e) {
                document.getElementById('relatedSection').classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            var params = new URLSearchParams(window.location.search);
            var filterState = { category: params.get('category') || '' };
            renderFilterSidebar('filterSidebarContainer');
            await loadFilterOptions(filterState);
            loadArticle();
            loadSharedHeaderData();
            setupSearchRedirect();
            setupFilterRedirect();
        });

        function loadSharedHeaderData() {
            fetch('/api/stats').then(function(r) { return r.json(); }).then(function(data) {
                var el = document.getElementById('totalArticles');
                if (el) el.textContent = data.total_articles.toLocaleString();
                el = document.getElementById('translatedArticles');
                if (el) el.textContent = data.translated_articles.toLocaleString();
            }).catch(function() {});
        }

        function goToIndexWithParams(params) {
            var q = new URLSearchParams(params);
            window.location.href = '/' + (q.toString() ? '?' + q.toString() : '');
        }

        function getArticleFilterParams() {
            var state = getFilterState();
            var params = {};
            if (state.category) params.category = state.category;
            return params;
        }

        function setupSearchRedirect() {
            var searchInput = document.getElementById('searchInput');
            var searchInputMobile = document.getElementById('searchInputMobile');
            function redirectSearch() {
                var params = getArticleFilterParams();
                var q = (searchInput && searchInput.value.trim()) || (searchInputMobile && searchInputMobile.value.trim()) || '';
                if (q) params.search = q;
                goToIndexWithParams(params);
            }
            if (searchInput) {
                searchInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); redirectSearch(); } });
            }
            if (searchInputMobile) {
                searchInputMobile.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); redirectSearch(); } });
                searchInputMobile.addEventListener('input', function() { if (searchInput) searchInput.value = searchInputMobile.value; });
            }
        }

        function setupFilterRedirect() {
            var categoryFilter = document.getElementById('categoryFilter');
            function redirectFilter() {
                var params = getArticleFilterParams();
                var searchInput = document.getElementById('searchInput');
                var searchInputMobile = document.getElementById('searchInputMobile');
                var q = (searchInput && searchInput.value.trim()) || (searchInputMobile && searchInputMobile.value.trim()) || '';
                if (q) params.search = q;
                goToIndexWithParams(params);
            }
            if (categoryFilter) categoryFilter.addEventListener('change', redirectFilter);
        }
    </script>

    <!-- Footer (rendered by footer.js) -->
    <div id="footer-container"></div>
    <script src="/static/js/footer.js"></script>
    <script>renderFooter();</script>
    <script src="/static/js/scroll-top.js"></script>
</body>
</html>
